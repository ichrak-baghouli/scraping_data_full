name: CI

on:
  push:
    branches: [main, master]
  pull_request:

jobs:
  test:
    name: Odoo module tests
    runs-on: ubuntu-latest
    container:
      image: odoo:18.0
      # Run as root so checkout can write to the mounted workspace.
      options: --user 0
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: odoo
          POSTGRES_PASSWORD: odoo
          POSTGRES_DB: odoo
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U odoo -d odoo"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install OS dependencies
        run: |
          apt-get update
          DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            python3-pip tesseract-ocr libtesseract-dev

      - name: Install Python dependencies
        run: |
          python3 -m pip install --upgrade pip --break-system-packages
          python3 -m pip install --break-system-packages \
            requests beautifulsoup4 pytesseract pillow rapidfuzz

      - name: Prepare module path
        run: |
          export EXTRA_ADDONS=/mnt/extra-addons
          mkdir -p "${EXTRA_ADDONS}"
          MODULE_NAME=$(basename "$GITHUB_WORKSPACE")
          cp -R "$GITHUB_WORKSPACE" "${EXTRA_ADDONS}/${MODULE_NAME}"
          echo "MODULE_NAME=${MODULE_NAME}" >> $GITHUB_ENV
          echo "EXTRA_ADDONS=${EXTRA_ADDONS}" >> $GITHUB_ENV

      - name: Run Odoo tests
        env:
          PGHOST: postgres
          PGUSER: odoo
          PGPASSWORD: odoo
          PGDATABASE: odoo
        run: |
          odoo --test-enable --stop-after-init \
            -d odoo \
            --db_host=postgres \
            --db_port=5432 \
            --db_user=odoo \
            --db_password=odoo \
            --addons-path="/usr/lib/python3/dist-packages/odoo/addons,${EXTRA_ADDONS}" \
            -i "${MODULE_NAME}"

