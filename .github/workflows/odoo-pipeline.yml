name: "TEST ODOO MODULE"

on:
  push:
    branches: [master, develop]
  pull_request:
    branches: [master]
  workflow_dispatch:

jobs:
  structure:
    name: "1. Structure"
    runs-on: ubuntu-latest
    
    steps:
    - name: "üì• T√©l√©charger code"
      uses: actions/checkout@v4

    - name: "üîç V√©rifier module"
      run: |
        echo "üîç V√âRIFICATION STRUCTURE"
        echo "========================="
        
        if [ ! -f "__manifest__.py" ]; then
          echo "‚ùå ERREUR: __manifest__.py manquant"
          exit 1
        fi
        
        echo "‚úÖ Module Odoo d√©tect√©"
        
        echo ""
        echo "üìÅ Structure:"
        ls -la
        
        if [ -d "tests" ]; then
          echo ""
          echo "üß™ Tests trouv√©s:"
          find tests -name "*.py"
        fi

  tests:
    name: "2. Tests unitaires"
    runs-on: ubuntu-latest
    needs: structure
    
    steps:
    - name: "üì• T√©l√©charger code"
      uses: actions/checkout@v4

    - name: "üêç Installer Python"
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: "üì¶ Installer Odoo et d√©pendances"
      run: |
        echo "üì¶ INSTALLATION ODOO"
        echo "===================="
        pip install --upgrade pip
        pip install werkzeug==2.2.3
        pip install git+https://github.com/odoo/odoo.git@16.0
        pip install pytest requests beautifulsoup4 lxml[html_clean]
        pip install pytest-mock

    - name: "üîß Configurer l'environnement Odoo"
      run: |
        echo "üîß CONFIGURATION ENVIRONNEMENT ODOO"
        echo "==================================="
        
        # Cr√©er la structure de module Odoo attendue
        mkdir -p /tmp/odoo/addons
        
        # Copier le module dans la structure Odoo
        cp -r . /tmp/odoo/addons/scraping_data_full
        
        # Cr√©er un fichier de configuration pour bypasser l'assertion
        cat > /tmp/odoo-config.py << 'EOF'
        import sys
        import os
        
        # Rediriger les imports odoo.addons vers notre structure
        class OdooAddonsFinder:
            def find_module(self, fullname, path=None):
                if fullname.startswith('odoo.addons.'):
                    return self
            
            def load_module(self, fullname):
                # Extraire le nom du module
                module_name = fullname.split('.')[-1]
                
                if module_name == 'scraping_data_full':
                    # Ajouter le chemin au sys.path
                    module_path = '/tmp/odoo/addons/scraping_data_full'
                    if module_path not in sys.path:
                        sys.path.insert(0, module_path)
                    
                    # Importer le module r√©el
                    import importlib.util
                    spec = importlib.util.spec_from_file_location(
                        'scraping_data_full',
                        os.path.join(module_path, '__init__.py')
                    )
                    module = importlib.util.module_from_spec(spec)
                    sys.modules[fullname] = module
                    spec.loader.exec_module(module)
                    return module
                
                # Pour les autres modules, cr√©er un module vide
                import types
                module = types.ModuleType(fullname)
                sys.modules[fullname] = module
                return module
        
        # Installer le finder
        sys.meta_path.insert(0, OdooAddonsFinder())
        print("‚úÖ Finder Odoo install√©")
        EOF

    - name: "üß™ Ex√©cuter les tests"
      run: |
        echo "üß™ EX√âCUTION TESTS"
        echo "=================="
        
        if [ -d "tests" ]; then
          echo "üìÇ Dossier tests trouv√©"
          
          # Aller dans le dossier du module Odoo
          cd /tmp/odoo/addons/scraping_data_full/tests
          
          # Ex√©cuter les tests avec la configuration Odoo
          PYTHONPATH="/tmp/odoo/addons/scraping_data_full:/tmp:$PYTHONPATH" \
          python -c "
          import sys
          sys.path.insert(0, '/tmp')
          import odoo-config
          import pytest
          exit(pytest.main(['-v', '.']))
          " 2>&1 | tee /tmp/test_results.log
          
          # Copier les r√©sultats
          cp /tmp/test_results.log /home/runner/work/scraping_data_full/scraping_data_full/test_results.log
        else
          echo "‚ùå Dossier tests non trouv√©"
          exit 1
        fi
        
        # Analyser les r√©sultats
        if grep -q "FAILED\|ERROR" /tmp/test_results.log; then
          echo "‚ùå Tests √©chou√©s"
          echo "--- Derni√®res erreurs ---"
          tail -50 /tmp/test_results.log
          exit 1
        else
          echo "‚úÖ Tests r√©ussis"
          echo "--- R√©sum√© ---"
          grep -E "passed|failed|error" /tmp/test_results.log | tail -20
        fi

    - name: "üíæ Sauvegarder r√©sultats"
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: resultats-tests
        path: test_results.log

  rapport:
    name: "3. Rapport"
    runs-on: ubuntu-latest
    needs: [structure, tests]
    
    steps:
    - name: "üì• T√©l√©charger code"
      uses: actions/checkout@v4

    - name: "üì• T√©l√©charger r√©sultats"
      uses: actions/download-artifact@v4
      with:
        name: resultats-tests

    - name: "üìä G√©n√©rer rapport"
      run: |
        echo "üìä RAPPORT FINAL"
        echo "================"
        echo ""
        
        if [ -f "test_results.log" ]; then
          echo "## üìà R√©sultats des tests"
          echo ""
          
          # Compter les tests
          TOTAL_TESTS=$(grep -c "PASSED\|FAILED\|ERROR" test_results.log || echo "0")
          PASSED_TESTS=$(grep -c "PASSED" test_results.log || echo "0")
          FAILED_TESTS=$(grep -c "FAILED\|ERROR" test_results.log || echo "0")
          
          echo "- **Total tests:** $TOTAL_TESTS"
          echo "- **Tests r√©ussis:** $PASSED_TESTS"
          echo "- **Tests √©chou√©s:** $FAILED_TESTS"
          echo ""
          
          if [ "$FAILED_TESTS" -gt 0 ]; then
            echo "## ‚ùå Erreurs d√©tect√©es"
            echo ""
            grep -A 5 -B 5 "FAILED\|ERROR" test_results.log | head -50
          else
            echo "## ‚úÖ Tous les tests ont r√©ussi"
            echo ""
            echo "F√©licitations ! Le module est fonctionnel."
          fi
          
          echo ""
          echo "## üìã Log complet"
          echo ""
          echo '```'
          tail -100 test_results.log
          echo '```'
        else
          echo "‚ö†Ô∏è Aucun r√©sultat de test trouv√©"
        fi