name: "Ã‰TAPE 1 - VÃ©rification Structure"

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  validate-structure:
    name: "1. VÃ©rifier la structure du module"
    runs-on: ubuntu-latest
    
    steps:
      - name: "ğŸ“¥ Checkout du code"
        uses: actions/checkout@v4

      - name: "ğŸ” Lister la structure"
        run: |
          echo "ğŸ“ STRUCTURE DU DÃ‰PÃ”T:"
          echo "====================="
          ls -la
          echo ""
          
          echo "ğŸŒ³ ARBRE COMPLET:"
          echo "================"
          find . -type f -not -path "./.git/*" | sort

      - name: "âœ… VÃ©rifier les fichiers obligatoires"
        run: |
          echo "ğŸ” VÃ‰RIFICATION DES FICHIERS OBLIGATOIRES:"
          echo "========================================="
          
          REQUIRED_FILES=0
          
          # VÃ©rifier __manifest__.py
          if [ -f "__manifest__.py" ]; then
            echo "âœ… __manifest__.py - PRESENT"
            REQUIRED_FILES=$((REQUIRED_FILES + 1))
            
            # Afficher le contenu
            echo "ğŸ“„ CONTENU DE __manifest__.py:"
            echo "------------------------------"
            cat __manifest__.py
            echo ""
            
            # Extraire le nom et la version
            MODULE_NAME=$(grep -oP "'name':\s*'\K[^']+" __manifest__.py 2>/dev/null || echo "Non trouvÃ©")
            MODULE_VERSION=$(grep -oP "'version':\s*'\K[^']+" __manifest__.py 2>/dev/null || echo "Non trouvÃ©")
            echo "ğŸ“Œ Nom du module: $MODULE_NAME"
            echo "ğŸ·ï¸ Version: $MODULE_VERSION"
          else
            echo "âŒ __manifest__.py - MANQUANT"
          fi
          
          # VÃ©rifier au moins un dossier
          if [ -d "models" ] || [ -d "views" ] || [ -d "controllers" ]; then
            echo "âœ… Dossier(s) Odoo - PRESENT(S)"
            REQUIRED_FILES=$((REQUIRED_FILES + 1))
            
            echo "ğŸ“‚ DOSSIERS TROUVÃ‰S:"
            for dir in models views controllers data security tests static; do
              if [ -d "$dir" ]; then
                echo "  ğŸ“ $dir/ ($(find $dir -type f | wc -l) fichiers)"
              fi
            done
          else
            echo "âš ï¸ Aucun dossier Odoo standard trouvÃ© (models/, views/, controllers/)"
          fi
          
          echo ""
          echo "ğŸ“Š RÃ‰SUMÃ‰: $REQUIRED_FILES/2 conditions remplies"
          
          if [ $REQUIRED_FILES -lt 1 ]; then
            echo "âŒ Ce n'est pas un module Odoo valide"
            exit 1
          else
            echo "âœ… Structure Odoo dÃ©tectÃ©e"
          fi

      - name: "ğŸ“Š GÃ©nÃ©rer le rapport structure"
        run: |
          echo "# RAPPORT STRUCTURE - scraping_data_full" > structure-report.md
          echo "**Date:** $(date)" >> structure-report.md
          echo "**Commit:** ${{ github.sha }}" >> structure-report.md
          echo "" >> structure-report.md
          
          echo "## ğŸ“ Fichiers et dossiers:" >> structure-report.md
          echo "\`\`\`" >> structure-report.md
          find . -type f -not -path "./.git/*" | sort >> structure-report.md
          echo "\`\`\`" >> structure-report.md
          
          echo "" >> structure-report.md
          echo "## âœ… Validation:" >> structure-report.md
          if [ -f "__manifest__.py" ]; then
            echo "- âœ… __manifest__.py prÃ©sent" >> structure-report.md
          else
            echo "- âŒ __manifest__.py manquant" >> structure-report.md
          fi
          
          echo "" >> structure-report.md
          echo "## ğŸ“¦ Statistiques:" >> structure-report.md
          echo "- Fichiers Python: $(find . -name "*.py" -not -path "./.git/*" | wc -l)" >> structure-report.md
          echo "- Fichiers XML: $(find . -name "*.xml" -not -path "./.git/*" | wc -l)" >> structure-report.md
          echo "- Taille totale: $(du -sh . | cut -f1)" >> structure-report.md
          
          echo "ğŸ“„ Rapport structure gÃ©nÃ©rÃ©"

      - name: "ğŸ“¤ Uploader le rapport"
        uses: actions/upload-artifact@v4
        with:
          name: 01-structure-report
          path: structure-report.md