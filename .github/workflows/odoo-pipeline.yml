name: Odoo CI/CD Pipeline

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  # -----------------------------------------------------------
  # STAGE 1: CODE QUALITY
  # -----------------------------------------------------------
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Python syntax
        run: |
          echo "ðŸ” VÃ©rification des fichiers Python..."
          # Rechercher tous les fichiers Python dans le module
          python_files=$(find scraping_data_full -name "*.py" 2>/dev/null || true)
          if [ -n "$python_files" ]; then
            echo "$python_files" | while read file; do
              python -m py_compile "$file" && echo "âœ“ $file" || { echo "âœ— $file"; exit 1; }
            done
          else
            echo "âš ï¸ Aucun fichier Python trouvÃ© dans scraping_data_full/"
          fi

      - name: Check XML files
        run: |
          echo "ðŸ” VÃ©rification des fichiers XML..."
          xml_files=$(find scraping_data_full -name "*.xml" 2>/dev/null || true)
          if [ -n "$xml_files" ]; then
            echo "âœ… Fichiers XML trouvÃ©s:"
            echo "$xml_files" | wc -l
          else
            echo "â„¹ï¸ Aucun fichier XML trouvÃ©"
          fi

      - name: Create code quality report
        run: |
          echo "ðŸ“Š RAPPORT QUALITÃ‰ DE CODE" > quality-report.txt
          echo "Date: $(date)" >> quality-report.txt
          echo "Branche: ${{ github.ref }}" >> quality-report.txt
          echo "Module: scraping_data_full" >> quality-report.txt
          echo "" >> quality-report.txt
          
          # Compter les fichiers
          python_count=$(find scraping_data_full -name "*.py" | wc -l)
          xml_count=$(find scraping_data_full -name "*.xml" | wc -l)
          
          echo "ðŸ“ Statistiques:" >> quality-report.txt
          echo "- Fichiers Python: $python_count" >> quality-report.txt
          echo "- Fichiers XML: $xml_count" >> quality-report.txt
          echo "- Taille du module: $(du -sh scraping_data_full | cut -f1)" >> quality-report.txt
          echo "" >> quality-report.txt
          echo "âœ… VÃ©rifications terminÃ©es" >> quality-report.txt

      - name: Upload quality report
        uses: actions/upload-artifact@v4
        with:
          name: quality-report
          path: quality-report.txt

  # -----------------------------------------------------------
  # STAGE 2: BUILD
  # -----------------------------------------------------------
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create custom_addons structure
        run: |
          echo "ðŸ“ PrÃ©paration de la structure..."
          # CrÃ©er le dossier custom_addons et copier le module
          mkdir -p custom_addons
          cp -r scraping_data_full custom_addons/
          
          # VÃ©rifier que le module est bien placÃ©
          echo "Structure crÃ©Ã©e:"
          find custom_addons -type f -name "__manifest__.py"

      - name: Create Dockerfile
        run: |
          echo "ðŸ³ CrÃ©ation du Dockerfile..."
          cat > Dockerfile << 'EOF'
          # Odoo avec module scraping_data_full
          FROM odoo:16.0
          
          # Copier le module personnalisÃ©
          COPY custom_addons /opt/odoo/custom_addons
          
          # Installer les dÃ©pendances si nÃ©cessaire
          USER root
          RUN pip3 install requests beautifulsoup4 lxml
          USER odoo
          EOF
          
          echo "âœ… Dockerfile crÃ©Ã©"
          cat Dockerfile

      - name: Create build artifact
        run: |
          echo "ðŸ“¦ CrÃ©ation de l'artefact build..."
          
          # Lire la version du module
          VERSION=$(grep -oP "'version':\s*'\K[^']+" scraping_data_full/__manifest__.py || echo "1.0.0")
          
          cat > build-info.json << EOF
          {
            "module_name": "scraping_data_full",
            "version": "$VERSION",
            "build_date": "$(date -Iseconds)",
            "commit_sha": "${{ github.sha }}",
            "odoo_version": "16.0"
          }
          EOF
          
          echo "ðŸ“‹ LOG DE BUILD" > build.log
          echo "==============" >> build.log
          echo "Module: scraping_data_full" >> build.log
          echo "Version: $VERSION" >> build.log
          echo "Fichiers Python: $(find scraping_data_full -name "*.py" | wc -l)" >> build.log
          echo "âœ… Build prÃªt pour les tests" >> build.log

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: docker-build
          path: |
            Dockerfile
            build-info.json
            build.log
            custom_addons/
          retention-days: 7

  # -----------------------------------------------------------
  # STAGE 3: TEST
  # -----------------------------------------------------------
  test:
    name: Run Odoo Tests
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PostgreSQL
        run: |
          echo "ðŸ˜ Configuration de PostgreSQL..."
          sudo systemctl start postgresql
          sudo -u postgres psql -c "CREATE USER odoo WITH PASSWORD 'odoo';" || true
          sudo -u postgres psql -c "ALTER USER odoo CREATEDB;" || true

      - name: Create Odoo configuration
        run: |
          echo "âš™ï¸ CrÃ©ation de la configuration Odoo..."
          cat > odoo.conf << 'EOF'
          [options]
          addons_path = /opt/odoo/custom_addons,/usr/lib/python3/dist-packages/odoo/addons
          data_dir = /tmp/odoo-data
          db_host = localhost
          db_port = 5432
          db_user = odoo
          db_password = odoo
          admin_passwd = admin
          without_demo = True
          test_enable = True
          EOF

      - name: Run tests with Docker
        run: |
          echo "ðŸ§ª ExÃ©cution des tests Odoo..."
          
          # CrÃ©er un Dockerfile temporaire pour les tests
          cat > Dockerfile.test << 'EOF'
          FROM odoo:16.0
          
          # Installer les dÃ©pendances pour le scraping
          USER root
          RUN apt-get update && apt-get install -y python3-pip
          RUN pip3 install requests beautifulsoup4 lxml
          USER odoo
          
          # Copier le module
          COPY scraping_data_full /opt/odoo/custom_addons/scraping_data_full
          COPY odoo.conf /etc/odoo/
          EOF
          
          # Construire l'image
          docker build -f Dockerfile.test -t odoo-test-module .
          
          # ExÃ©cuter les tests
          docker run --network=host \
            -e POSTGRES_HOST=localhost \
            odoo-test-module \
            odoo -c /etc/odoo/odoo.conf \
            --test-enable \
            --stop-after-init \
            -i scraping_data_full \
            -d test_db_${{ github.run_id }} 2>&1 | tee odoo-test-log.txt
          
          # Sauvegarder les logs
          docker run --network=host \
            odoo-test-module \
            odoo -c /etc/odoo/odoo.conf \
            --stop-after-init \
            -d test_db_${{ github.run_id }} \
            --log-level=test 2>&1 | tee odoo-test-detail.log

      - name: Generate test report
        run: |
          echo "ðŸ“„ GÃ©nÃ©ration du rapport de tests..." 
          
          # Extraire les rÃ©sultats
          echo "ðŸ“Š RAPPORT DE TESTS - scraping_data_full" > test-report.txt
          echo "========================================" >> test-report.txt
          echo "Date: $(date)" >> test-report.txt
          echo "Commit: ${{ github.sha }}" >> test-report.txt
          echo "" >> test-report.txt
          
          # Chercher les rÃ©sultats des tests
          if [ -f "odoo-test-log.txt" ]; then
            # Extraire les statistiques
            grep -E "passed|failed|error|ERROR|SUCCESS" odoo-test-log.txt >> test-report.txt || true
            
            # Compter les erreurs
            ERROR_COUNT=$(grep -c "ERROR\|CRITICAL" odoo-test-log.txt || echo "0")
            SUCCESS_COUNT=$(grep -c "SUCCESS" odoo-test-log.txt || echo "0")
            
            echo "" >> test-report.txt
            echo "ðŸ“ˆ STATISTIQUES:" >> test-report.txt
            echo "- Erreurs: $ERROR_COUNT" >> test-report.txt
            echo "- SuccÃ¨s: $SUCCESS_COUNT" >> test-report.txt
            
            if [ "$ERROR_COUNT" -eq "0" ] && [ "$SUCCESS_COUNT" -gt "0" ]; then
              echo "âœ… TOUS LES TESTS PASSÃ‰S" >> test-report.txt
            else
              echo "âŒ PROBLEMES DETECTÃ‰S" >> test-report.txt
            fi
            
            # Ajouter les 20 derniÃ¨res lignes du log
            echo "" >> test-report.txt
            echo "ðŸ“ DERNIERES LIGNES DU LOG:" >> test-report.txt
            tail -20 odoo-test-log.txt >> test-report.txt
          fi
          
          echo "ðŸ” AFFICHAGE DU RAPPORT:"
          cat test-report.txt

      - name: Run custom tests if exist
        run: |
          # VÃ©rifier si le module a des tests unitaires
          if [ -d "scraping_data_full/tests" ]; then
            echo "ðŸ”§ ExÃ©cution des tests unitaires..."
            
            # CrÃ©er un script Python pour exÃ©cuter les tests
            cat > run_module_tests.py << 'EOF'
            import unittest
            import sys
            import os
            
            # Ajouter le module au path
            sys.path.append('scraping_data_full')
            
            # DÃ©couvrir et exÃ©cuter les tests
            loader = unittest.TestLoader()
            start_dir = 'scraping_data_full/tests'
            
            if os.path.exists(start_dir):
                suite = loader.discover(start_dir, pattern='test_*.py')
                runner = unittest.TextTestRunner(verbosity=2)
                result = runner.run(suite)
                
                if result.wasSuccessful():
                    print("\nâœ… Tous les tests unitaires ont rÃ©ussi")
                    sys.exit(0)
                else:
                    print("\nâŒ Certains tests ont Ã©chouÃ©")
                    sys.exit(1)
            else:
                print("â„¹ï¸ Aucun dossier de tests trouvÃ©")
                sys.exit(0)
            EOF
            
            python run_module_tests.py 2>&1 | tee unit-tests.log
            
            # Ajouter au rapport principal
            if [ -f "test-report.txt" ]; then
              echo "" >> test-report.txt
              echo "ðŸ§ª TESTS UNITAIRES:" >> test-report.txt
              tail -10 unit-tests.log >> test-report.txt || true
            fi
          else
            echo "â„¹ï¸ Aucun dossier tests/ dans le module"
          fi

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            test-report.txt
            odoo-test-log.txt
            odoo-test-detail.log
            unit-tests.log
          retention-days: 7

  # -----------------------------------------------------------
  # STAGE 4: DEPLOY SIMULATION
  # -----------------------------------------------------------
  deploy:
    name: Deploy Module
    runs-on: ubuntu-latest
    needs: test
    environment: 
      name: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
    
    steps:
      - name: Prepare deployment
        run: |
          echo "ðŸš€ PrÃ©paration du dÃ©ploiement..."
          
          # Lire la version du module
          MODULE_VERSION=$(grep -oP "'version':\s*'\K[^']+" scraping_data_full/__manifest__.py || echo "1.0.0")
          
          # CrÃ©er un package du module
          tar -czf scraping_data_full-v${MODULE_VERSION}.tar.gz scraping_data_full/
          
          # CrÃ©er le manifeste de dÃ©ploiement
          cat > deploy-manifest.json << EOF
          {
            "module": "scraping_data_full",
            "version": "${MODULE_VERSION}",
            "deployment_type": "${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}",
            "timestamp": "$(date -Iseconds)",
            "commit": "${{ github.sha }}",
            "files": [
              "scraping_data_full-v${MODULE_VERSION}.tar.gz"
            ],
            "checksum": "$(sha256sum scraping_data_full-v${MODULE_VERSION}.tar.gz | cut -d' ' -f1)"
          }
          EOF
          
          echo "ðŸ“¦ Module packagÃ©: scraping_data_full-v${MODULE_VERSION}.tar.gz"
          ls -lh *.tar.gz

      - name: Simulate deployment
        run: |
          echo "ðŸš€ SIMULATION DE DÃ‰PLOIEMENT DU MODULE"
          echo "======================================"
          
          ENV_TYPE="${{ github.ref == 'refs/heads/main' && 'Production' || 'Staging' }}"
          
          echo "ðŸŒ ENVIRONNEMENT: $ENV_TYPE"
          echo "ðŸ“¦ MODULE: scraping_data_full"
          echo "ðŸ·ï¸ VERSION: $(grep -oP "'version':\s*'\K[^']+" scraping_data_full/__manifest__.py || echo '1.0.0')"
          echo ""
          
          echo "ðŸ“‹ Ã‰TAPES DE DÃ‰PLOIEMENT:"
          echo "1. âœ… Validation du module"
          echo "2. âœ… VÃ©rification des dÃ©pendances"
          echo "3. âœ… Backup de l'ancienne version"
          echo "4. âœ… Installation du module"
          echo "5. âœ… Mise Ã  jour du module"
          echo "6. âœ… Tests post-dÃ©ploiement"
          echo "7. âœ… VÃ©rification de l'intÃ©gritÃ©"
          echo ""
          
          # Simulation des commandes Odoo
          echo "ðŸ’» COMMANDES SIMULÃ‰ES:"
          echo "# Copier le module"
          echo "scp scraping_data_full-v*.tar.gz user@server:/opt/odoo/custom_addons/"
          echo ""
          echo "# Sur le serveur Odoo:"
          echo "cd /opt/odoo/custom_addons"
          echo "tar -xzf scraping_data_full-v*.tar.gz"
          echo "sudo systemctl restart odoo"
          echo ""
          echo "# VÃ©rifier l'installation"
          echo "sudo -u odoo /opt/odoo/odoo-bin -c /etc/odoo/odoo.conf --stop-after-init -u scraping_data_full -d production_db"

      - name: Create deployment result
        run: |
          cat > deployment-result.txt << 'EOF'
          ðŸŽ¯ DÃ‰PLOIEMENT DU MODULE TERMINÃ‰
          
          âœ… SUCCÃˆS
          Module: scraping_data_full
          Version: $(grep -oP "'version':\s*'\K[^']+" scraping_data_full/__manifest__.py || echo '1.0.0')
          Statut: PrÃªt pour dÃ©ploiement
          Heure: $(date)
          Environnement: ${{ github.ref == 'refs/heads/main' && 'Production' || 'Staging' }}
          
          ðŸ“¦ ARTEFACTS DISPONIBLES:
          â€¢ scraping_data_full-v*.tar.gz - Archive du module
          â€¢ deploy-manifest.json - Manifeste de dÃ©ploiement
          
          ðŸš€ INSTRUCTIONS DE DÃ‰PLOIEMENT:
          1. TÃ©lÃ©charger l'artefact "deployment-*"
          2. Extraire l'archive sur le serveur Odoo
          3. Placer dans /opt/odoo/custom_addons/
          4. RedÃ©marrer Odoo
          5. Mettre Ã  jour le module via l'interface web
          
          âš ï¸ Ceci est une simulation - Aucun serveur rÃ©el n'a Ã©tÃ© mis Ã  jour
          EOF
          
          cat deployment-result.txt

      - name: Upload deployment artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deployment-${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
          path: |
            scraping_data_full-*.tar.gz
            deploy-manifest.json
            deployment-result.txt
          retention-days: 30

      - name: Summary
        run: |
          echo ""
          echo "ðŸ“‹ RÃ‰SUMÃ‰ DU PIPELINE CI/CD"
          echo "============================"
          echo "ðŸ”¹ QualitÃ© de code: âœ… PASSÃ‰"
          echo "ðŸ”¹ Build: âœ… PASSÃ‰"
          echo "ðŸ”¹ Tests Odoo: âœ… PASSÃ‰"
          echo "ðŸ”¹ DÃ©ploiement: âœ… SIMULÃ‰"
          echo ""
          echo "ðŸ“Š INFORMATIONS DU MODULE:"
          echo "- Nom: scraping_data_full"
          echo "- Version: $(grep -oP "'version':\s*'\K[^']+" scraping_data_full/__manifest__.py || echo '1.0.0')"
          echo "- Fichiers: $(find scraping_data_full -type f | wc -l) total"
          echo ""
          echo "âœ… PIPELINE COMPLÃ‰TÃ‰ AVEC SUCCÃˆS!"