name: "TEST ODOO MODULE"

on:
  push:
    branches: [master, develop]
  pull_request:
    branches: [master]
  workflow_dispatch:

jobs:
  structure:
    name: "1. Structure"
    runs-on: ubuntu-latest
    
    steps:
    - name: "ðŸ“¥ TÃ©lÃ©charger code"
      uses: actions/checkout@v4

    - name: "ðŸ” VÃ©rifier module"
      run: |
        echo "ðŸ” VÃ‰RIFICATION STRUCTURE"
        echo "========================="
        
        if [ ! -f "__manifest__.py" ]; then
          echo "âŒ ERREUR: __manifest__.py manquant"
          exit 1
        fi
        
        echo "âœ… Module Odoo dÃ©tectÃ©"
        
        echo ""
        echo "ðŸ“ Structure:"
        ls -la
        
        if [ -d "tests" ]; then
          echo ""
          echo "ðŸ§ª Tests trouvÃ©s:"
          find tests -name "*.py"
        fi

  tests:
    name: "2. Tests unitaires"
    runs-on: ubuntu-latest
    needs: structure
    
    steps:
    - name: "ðŸ“¥ TÃ©lÃ©charger code"
      uses: actions/checkout@v4

    - name: "ðŸ Installer Python"
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: "ðŸ“¦ Installer Odoo"
      run: |
        echo "ðŸ“¦ INSTALLATION ODOO"
        echo "===================="
        pip install git+https://github.com/odoo/odoo.git@16.0
        pip install pytest requests beautifulsoup4 lxml[html_clean]

    - name: "ðŸ§ª ExÃ©cuter tests"
      run: |
        echo "ðŸ§ª EXÃ‰CUTION TESTS"
        echo "=================="
        
        if [ -d "tests" ]; then
          echo "ðŸ“‚ Dossier tests trouvÃ©"
          cd tests
          python -m pytest . -v 2>&1 | tee test_results.log
          cd ..
        else
          TEST_FILES=$(find . -name "test_*.py" -not -path "./.git/*")
          if [ -n "$TEST_FILES" ]; then
            echo "ðŸ“„ Fichiers test_*.py trouvÃ©s"
            python -m pytest $TEST_FILES -v 2>&1 | tee test_results.log
          else
            echo "âŒ Aucun test trouvÃ©"
            exit 1
          fi
        fi
        
        if grep -q "FAILED\|ERROR" test_results.log; then
          echo "âŒ Tests Ã©chouÃ©s"
          exit 1
        else
          echo "âœ… Tests rÃ©ussis"
        fi

    - name: "ðŸ’¾ Sauvegarder rÃ©sultats"
      uses: actions/upload-artifact@v4
      with:
        name: resultats-tests
        path: test_results.log

  rapport:
    name: "3. Rapport"
    runs-on: ubuntu-latest
    needs: [structure, tests]
    
    steps:
    - name: "ðŸ“¥ TÃ©lÃ©charger code"
      uses: actions/checkout@v4

    - name: "ðŸ“Š GÃ©nÃ©rer rapport"
      run: |
        echo "ðŸ“Š RAPPORT FINAL"
        echo "================"
        
        cat > RAPPORT.md << 'EOF'

