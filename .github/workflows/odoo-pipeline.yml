name: CI

on:
  push:
    branches: [main, master]
  pull_request:
  workflow_dispatch:
  # Deployment condition uses tags (refs/tags/v*)

jobs:
  quality:
    name: Quality (lint basic)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Style check (basic)
        run: |
          python3 -m pip install --break-system-packages --no-cache-dir ruff
          ruff check .

  build:
    name: Build package
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create addon archive
        run: |
          MODULE_NAME=$(basename "$GITHUB_WORKSPACE")
          TMP_DIR=$(mktemp -d)
          rsync -a --exclude=".git" --exclude=".github" --exclude="dist" --exclude="__pycache__" ./ "${TMP_DIR}/"
          tar -czf "${MODULE_NAME}.tar.gz" -C "${TMP_DIR}" .
          echo "ARTIFACT=${MODULE_NAME}.tar.gz" >> $GITHUB_ENV

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: odoo-addon
          path: "${{ env.ARTIFACT }}"
          retention-days: 7

  test:
    name: Odoo module tests
    runs-on: ubuntu-latest
    needs: build
    container:
      image: odoo:18.0
      # Run as root so checkout can write to the mounted workspace.
      options: --user 0
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: odoo
          POSTGRES_PASSWORD: odoo
          POSTGRES_DB: odoo
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U odoo -d odoo"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install OS dependencies
        run: |
          apt-get update
          DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            python3-pip tesseract-ocr libtesseract-dev

      - name: Install Python dependencies
        run: |
          python3 -m pip install --break-system-packages --no-cache-dir \
            requests beautifulsoup4 pytesseract pillow rapidfuzz

      - name: Prepare module path
        run: |
          export EXTRA_ADDONS=/mnt/extra-addons
          mkdir -p "${EXTRA_ADDONS}"
          MODULE_NAME=$(basename "$GITHUB_WORKSPACE")
          cp -R "$GITHUB_WORKSPACE" "${EXTRA_ADDONS}/${MODULE_NAME}"
          echo "MODULE_NAME=${MODULE_NAME}" >> $GITHUB_ENV
          echo "EXTRA_ADDONS=${EXTRA_ADDONS}" >> $GITHUB_ENV

      - name: Run Odoo tests
        env:
          PGHOST: postgres
          PGUSER: odoo
          PGPASSWORD: odoo
          PGDATABASE: odoo
        run: |
          odoo --test-enable --stop-after-init \
            -d odoo \
            --db_host=postgres \
            --db_port=5432 \
            --db_user=odoo \
            --db_password=odoo \
            --addons-path="/usr/lib/python3/dist-packages/odoo/addons,${EXTRA_ADDONS}" \
            -i "${MODULE_NAME}" \
            --test-tags "${MODULE_NAME}"

  deploy:
    name: Deploy (Docker image)
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read
      packages: write  # needed to push to GHCR
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set image tags
        id: vars
        run: |
          IMAGE=ghcr.io/${{ github.repository }}
          TAG=${GITHUB_REF_NAME}
          echo "image=${IMAGE}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        env:
          IMAGE: ${{ steps.vars.outputs.image }}
          TAG: ${{ steps.vars.outputs.tag }}
        run: |
          docker build -t "${IMAGE}:${TAG}" -t "${IMAGE}:latest" .
          docker push "${IMAGE}:${TAG}"
          docker push "${IMAGE}:latest"

